<!-- Mantenedor de Cámaras -->
<div class="camera-manager-container">
  <!-- Header -->
  <div class="manager-header">
    <h2>
      <mat-icon>settings</mat-icon>
      Gestión de Cámaras
    </h2>
    <div class="header-actions">
      <button mat-raised-button color="primary" (click)="showAddForm()" *ngIf="!showForm">
        <mat-icon>add</mat-icon>
        Agregar Cámara
      </button>
      <button mat-icon-button (click)="reload()" matTooltip="Recargar">
        <mat-icon>refresh</mat-icon>
      </button>
    </div>
  </div>

  <!-- Formulario de Cámara -->
  <mat-card *ngIf="showForm" class="form-card">
    <mat-card-header>
      <mat-card-title>
        {{ isEditing ? 'Editar Cámara' : 'Nueva Cámara' }}
      </mat-card-title>
    </mat-card-header>
    
    <mat-card-content>
      <form [formGroup]="cameraForm" class="camera-form">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Nombre de la Cámara</mat-label>
          <input matInput formControlName="name" placeholder="Ej: Cámara Sala Principal">
          <mat-icon matPrefix>label</mat-icon>
          <mat-error *ngIf="cameraForm.get('name')?.hasError('required')">
            El nombre es requerido
          </mat-error>
          <mat-error *ngIf="cameraForm.get('name')?.hasError('minlength')">
            Mínimo 3 caracteres
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>URL RTSP</mat-label>
          <input matInput formControlName="rtsp_url" placeholder="rtsp://usuario:contraseña&#64;ip:puerto/ruta">
          <mat-icon matPrefix>link</mat-icon>
          <mat-hint>Formato: rtsp://usuario:contraseña&#64;192.168.1.100:554/stream</mat-hint>
          <mat-error *ngIf="cameraForm.get('rtsp_url')?.hasError('required')">
            La URL RTSP es requerida
          </mat-error>
          <mat-error *ngIf="cameraForm.get('rtsp_url')?.hasError('pattern')">
            Debe ser una URL RTSP válida
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Ubicación</mat-label>
          <input matInput formControlName="location" placeholder="Ej: Sala de juegos - Vista frontal">
          <mat-icon matPrefix>place</mat-icon>
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Descripción</mat-label>
          <textarea matInput formControlName="description" rows="3" placeholder="Descripción opcional"></textarea>
          <mat-icon matPrefix>description</mat-icon>
        </mat-form-field>
      </form>
    </mat-card-content>

    <mat-card-actions>
      <button mat-raised-button color="primary" (click)="saveCamera()" [disabled]="cameraForm.invalid">
        <mat-icon>save</mat-icon>
        {{ isEditing ? 'Actualizar' : 'Guardar' }}
      </button>
      <button mat-button (click)="cancelForm()">
        <mat-icon>cancel</mat-icon>
        Cancelar
      </button>
    </mat-card-actions>
  </mat-card>

  <!-- Loading -->
  <div *ngIf="loading" class="loading-container">
    <mat-spinner></mat-spinner>
    <p>Cargando cámaras...</p>
  </div>

  <!-- Error -->
  <div *ngIf="error" class="error-container">
    <mat-icon>error</mat-icon>
    <p>{{ error }}</p>
    <button mat-raised-button color="primary" (click)="reload()">
      Reintentar
    </button>
  </div>

  <!-- Tabla de Cámaras -->
  <mat-card *ngIf="!loading && !error" class="table-card">
    <mat-card-content>
      <div class="table-container">
        <table mat-table [dataSource]="dataSource">
          
          <!-- Columna ID -->
          <ng-container matColumnDef="id">
            <th mat-header-cell *matHeaderCellDef>ID</th>
            <td mat-cell *matCellDef="let camera">
              <span class="id-badge">{{ camera.id }}</span>
            </td>
          </ng-container>

          <!-- Columna Nombre -->
          <ng-container matColumnDef="name">
            <th mat-header-cell *matHeaderCellDef>Nombre</th>
            <td mat-cell *matCellDef="let camera">
              <div class="camera-name">
                <mat-icon>videocam</mat-icon>
                <span>{{ camera.name }}</span>
              </div>
            </td>
          </ng-container>

          <!-- Columna Ubicación -->
          <ng-container matColumnDef="location">
            <th mat-header-cell *matHeaderCellDef>Ubicación</th>
            <td mat-cell *matCellDef="let camera">
              <span class="location-text">{{ camera.location || '-' }}</span>
            </td>
          </ng-container>

          <!-- Columna Estado -->
          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef>Estado</th>
            <td mat-cell *matCellDef="let camera">
              <div class="status-cell">
                <mat-icon [class]="getStatusClass(camera.status)">
                  {{ getStatusIcon(camera.status) }}
                </mat-icon>
                <span>{{ getStatusText(camera.status) }}</span>
              </div>
            </td>
          </ng-container>

          <!-- Columna Acciones -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>Acciones</th>
            <td mat-cell *matCellDef="let camera">
              <div class="action-buttons">
                <button 
                  mat-icon-button 
                  color="primary"
                  (click)="editCamera(camera)" 
                  matTooltip="Editar">
                  <mat-icon>edit</mat-icon>
                </button>
                
                <button 
                  mat-icon-button 
                  color="accent"
                  *ngIf="camera.status !== 'connected'"
                  (click)="startCamera(camera)" 
                  matTooltip="Iniciar stream">
                  <mat-icon>play_arrow</mat-icon>
                </button>
                
                <button 
                  mat-icon-button 
                  color="warn"
                  *ngIf="camera.status === 'connected'"
                  (click)="stopCamera(camera)" 
                  matTooltip="Detener stream">
                  <mat-icon>stop</mat-icon>
                </button>
                
                <button 
                  mat-icon-button 
                  color="warn"
                  (click)="deleteCamera(camera)" 
                  matTooltip="Eliminar">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>

          <!-- Fila cuando no hay datos -->
          <tr class="mat-row" *matNoDataRow>
            <td class="mat-cell" [attr.colspan]="displayedColumns.length">
              <div class="no-data-container">
                <mat-icon>videocam_off</mat-icon>
                <p>No hay cámaras registradas</p>
                <button mat-raised-button color="primary" (click)="showAddForm()">
                  <mat-icon>add</mat-icon>
                  Agregar Primera Cámara
                </button>
              </div>
            </td>
          </tr>
        </table>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Información de ayuda -->
  <mat-card class="help-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>help_outline</mat-icon>
        Ayuda
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <h4>Formato de URL RTSP</h4>
      <p>Las URLs RTSP siguen este formato:</p>
      <code>rtsp://usuario:contraseña&#64;direccion_ip:puerto/ruta</code>
      
      <h4>Ejemplos comunes:</h4>
      <ul>
        <li><code>rtsp://admin:12345&#64;192.168.1.100:554/stream1</code></li>
        <li><code>rtsp://user:pass&#64;192.168.0.20:554/Preview_01_main</code></li>
        <li><code>rtsp://camera.local:554/live/ch00_0</code></li>
      </ul>

      <h4>Puertos comunes:</h4>
      <ul>
        <li><strong>554:</strong> Puerto estándar RTSP</li>
        <li><strong>8554:</strong> Puerto alternativo común</li>
      </ul>

      <h4>Notas:</h4>
      <ul>
        <li>Asegúrate de que la cámara esté en la misma red o sea accesible</li>
        <li>Verifica que las credenciales sean correctas</li>
        <li>Algunos fabricantes usan rutas específicas (consulta el manual de tu cámara)</li>
      </ul>
    </mat-card-content>
  </mat-card>
</div>
